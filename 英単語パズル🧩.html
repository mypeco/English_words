<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eigo Puzzle - è‹±èªã‚¹ãƒšãƒ«ãƒ‘ã‚ºãƒ«</title>
    
    <!-- Google Fonts (ä¸¸æ–‡å­—ã§ã‹ã‚ã„ã) -->
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
            -webkit-tap-highlight-color: transparent;
        }
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
        @keyframes spin-in {
            from { transform: rotate(-180deg) scale(0); opacity: 0; }
            to { transform: rotate(0) scale(1); opacity: 1; }
        }
        .animate-spin-in {
            animation: spin-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        /* æ–°ã—ã„ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ­¢ã¾ã£ã¦ã„ã¦ã€æ™‚ã€…å…‰ã‚‹ï¼‰ */
        @keyframes shine {
            0%, 80% { transform: scale(1); filter: brightness(100%) drop-shadow(0 1px 1px rgba(0,0,0,0.1)); }
            85% { transform: scale(1.2) rotate(-5deg); filter: brightness(130%) drop-shadow(0 0 5px rgba(255,215,0,0.6)); }
            90% { transform: scale(1.2) rotate(5deg); filter: brightness(130%) drop-shadow(0 0 5px rgba(255,215,0,0.6)); }
            100% { transform: scale(1); filter: brightness(100%) drop-shadow(0 1px 1px rgba(0,0,0,0.1)); }
        }
        .animate-shine {
            animation: shine 4s infinite; /* 4ç§’ã«1å›ã‚­ãƒ©ãƒƒã¨ã™ã‚‹ */
            display: inline-block;
        }
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
        /* ãƒ«ãƒ“ã®èª¿æ•´ */
        ruby {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        rt {
            font-size: 0.6em;
            font-weight: normal;
            color: #f1f5f9; /* slate-100 (ç™½æŠœãæ–‡å­—ã®ä¸Šãªã®ã§æ˜ã‚‹ã) */
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">

    <!-- ã‚¢ãƒ—ãƒªæç”»ã‚¨ãƒªã‚¢ -->
    <div id="app" class="min-h-screen flex flex-col"></div>

    <script>
        // --- 1. ãƒ‡ãƒ¼ã‚¿å®šç¾© (å…¨28ã‚«ãƒ†ã‚´ãƒª) ---
        // ã‚«ãƒ†ã‚´ãƒªåã‚’ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã«çµ±ä¸€ã—ã€è‰²ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆã‚ã›ã¦èª¿æ•´
        
        const DATA = {
            // --- Group 1: ğŸ‘‘ ã¯ã˜ã‚ã‚ˆã† (Basics) [æš–è‰²ç³»: Orange/Yellow/Pink] ---
            num1: { id: 'num1', label: 'ã™ã†ã˜â‘  (1-10)', color: 'from-orange-400 to-amber-500', words: [ { en: 'one', jp: '1', emoji: '1ï¸âƒ£' }, { en: 'two', jp: '2', emoji: '2ï¸âƒ£' }, { en: 'three', jp: '3', emoji: '3ï¸âƒ£' }, { en: 'four', jp: '4', emoji: '4ï¸âƒ£' }, { en: 'five', jp: '5', emoji: '5ï¸âƒ£' }, { en: 'six', jp: '6', emoji: '6ï¸âƒ£' }, { en: 'seven', jp: '7', emoji: '7ï¸âƒ£' }, { en: 'eight', jp: '8', emoji: '8ï¸âƒ£' }, { en: 'nine', jp: '9', emoji: '9ï¸âƒ£' }, { en: 'ten', jp: '10', emoji: 'ğŸ”Ÿ' } ] },
            colors: { id: 'colors', label: 'ã„ã‚ (Colors)', color: 'from-amber-400 to-yellow-500', words: [ { en: 'red', jp: '<ruby>èµ¤<rt>ã‚ã‹</rt></ruby>', emoji: 'ğŸ”´' }, { en: 'blue', jp: '<ruby>é’<rt>ã‚ãŠ</rt></ruby>', emoji: 'ğŸ”µ' }, { en: 'yellow', jp: '<ruby>é»„<rt>ãã„ã‚</rt></ruby>', emoji: 'ğŸŸ¡' }, { en: 'green', jp: '<ruby>ç·‘<rt>ã¿ã©ã‚Š</rt></ruby>', emoji: 'ğŸŸ¢' }, { en: 'orange', jp: 'ã‚ªãƒ¬ãƒ³ã‚¸', emoji: 'ğŸŸ ' }, { en: 'pink', jp: 'ãƒ”ãƒ³ã‚¯', emoji: 'ğŸ’—' }, { en: 'purple', jp: '<ruby>ç´«<rt>ã‚€ã‚‰ã•ã</rt></ruby>', emoji: 'ğŸŸ£' }, { en: 'black', jp: '<ruby>é»’<rt>ãã‚</rt></ruby>', emoji: 'âš«' }, { en: 'white', jp: '<ruby>ç™½<rt>ã—ã‚</rt></ruby>', emoji: 'âšª' }, { en: 'brown', jp: '<ruby>èŒ¶è‰²<rt>ã¡ã‚ƒã„ã‚</rt></ruby>', emoji: 'ğŸŸ¤' }, { en: 'gold', jp: '<ruby>é‡‘<rt>ãã‚“</rt></ruby>', emoji: 'ğŸ¥‡' }, { en: 'silver', jp: '<ruby>éŠ€<rt>ãã‚“</rt></ruby>', emoji: 'ğŸ¥ˆ' } ] },
            animals: { id: 'animals', label: 'ã©ã†ã¶ã¤ (Animals)', color: 'from-yellow-400 to-lime-500', words: [ { en: 'dog', jp: '<ruby>çŠ¬<rt>ã„ã¬</rt></ruby>', emoji: 'ğŸ¶' }, { en: 'cat', jp: '<ruby>çŒ«<rt>ã­ã“</rt></ruby>', emoji: 'ğŸ±' }, { en: 'rabbit', jp: 'ã‚¦ã‚µã‚®', emoji: 'ğŸ°' }, { en: 'bird', jp: '<ruby>é³¥<rt>ã¨ã‚Š</rt></ruby>', emoji: 'ğŸ¦' }, { en: 'fish', jp: '<ruby>é­š<rt>ã•ã‹ãª</rt></ruby>', emoji: 'ğŸŸ' }, { en: 'bear', jp: 'ã‚¯ãƒ', emoji: 'ğŸ»' }, { en: 'lion', jp: 'ãƒ©ã‚¤ã‚ªãƒ³', emoji: 'ğŸ¦' }, { en: 'tiger', jp: 'ãƒˆãƒ©', emoji: 'ğŸ¯' }, { en: 'elephant', jp: 'ã‚¾ã‚¦', emoji: 'ğŸ˜' }, { en: 'monkey', jp: 'ã‚µãƒ«', emoji: 'ğŸµ' }, { en: 'panda', jp: 'ãƒ‘ãƒ³ãƒ€', emoji: 'ğŸ¼' }, { en: 'horse', jp: 'ã‚¦ãƒ', emoji: 'ğŸ´' }, { en: 'cow', jp: 'ã‚¦ã‚·', emoji: 'ğŸ®' }, { en: 'pig', jp: 'ãƒ–ã‚¿', emoji: 'ğŸ·' } ] },
            food: { id: 'food', label: 'ãŸã¹ã‚‚ã® (Food)', color: 'from-lime-500 to-green-500', words: [ { en: 'apple', jp: 'ãƒªãƒ³ã‚´', emoji: 'ğŸ' }, { en: 'banana', jp: 'ãƒãƒŠãƒŠ', emoji: 'ğŸŒ' }, { en: 'orange', jp: 'ã‚ªãƒ¬ãƒ³ã‚¸', emoji: 'ğŸŠ' }, { en: 'grape', jp: 'ãƒ–ãƒ‰ã‚¦', emoji: 'ğŸ‡' }, { en: 'peach', jp: 'ãƒ¢ãƒ¢', emoji: 'ğŸ‘' }, { en: 'rice', jp: '<ruby>ã”é£¯<rt>ã¯ã‚“</rt></ruby>', emoji: 'ğŸš' }, { en: 'bread', jp: 'ãƒ‘ãƒ³', emoji: 'ğŸ' }, { en: 'egg', jp: '<ruby>åµ<rt>ãŸã¾ã”</rt></ruby>', emoji: 'ğŸ¥š' }, { en: 'curry', jp: 'ã‚«ãƒ¬ãƒ¼', emoji: 'ğŸ›' }, { en: 'hamburger', jp: 'ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼', emoji: 'ğŸ”' }, { en: 'pizza', jp: 'ãƒ”ã‚¶', emoji: 'ğŸ•' }, { en: 'cake', jp: 'ã‚±ãƒ¼ã‚­', emoji: 'ğŸ°' }, { en: 'ice cream', jp: 'ã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ', emoji: 'ğŸ¦' } ] },
            family: { id: 'family', label: 'ã‹ãã (Family)', color: 'from-pink-400 to-rose-500', words: [ { en: 'family', jp: '<ruby>å®¶æ—<rt>ã‹ãã</rt></ruby>', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦' }, { en: 'father', jp: '<ruby>çˆ¶<rt>ã¡ã¡</rt></ruby>', emoji: 'ğŸ‘¨' }, { en: 'mother', jp: '<ruby>æ¯<rt>ã¯ã¯</rt></ruby>', emoji: 'ğŸ‘©' }, { en: 'brother', jp: '<ruby>å…„<rt>ã‚ã«</rt></ruby>ãƒ»<ruby>å¼Ÿ<rt>ãŠã¨ã†ã¨</rt></ruby>', emoji: 'ğŸ‘¦' }, { en: 'sister', jp: '<ruby>å§‰<rt>ã‚ã­</rt></ruby>ãƒ»<ruby>å¦¹<rt>ã„ã‚‚ã†ã¨</rt></ruby>', emoji: 'ğŸ‘§' }, { en: 'grandfather', jp: '<ruby>ç¥–çˆ¶<rt>ããµ</rt></ruby>', emoji: 'ğŸ‘´' }, { en: 'grandmother', jp: '<ruby>ç¥–æ¯<rt>ãã¼</rt></ruby>', emoji: 'ğŸ‘µ' } ] },
            adj2: { id: 'adj2', label: 'ãã‚‚ã¡ (Feelings)', color: 'from-rose-400 to-red-500', words: [ { en: 'happy', jp: '<ruby>å¹¸<rt>ã—ã‚ã‚</rt></ruby>ã›', emoji: 'ğŸ˜„' }, { en: 'sad', jp: '<ruby>æ‚²<rt>ã‹ãª</rt></ruby>ã—ã„', emoji: 'ğŸ˜¢' }, { en: 'nice', jp: '<ruby>ç´ æ•µ<rt>ã™ã¦ã</rt></ruby>', emoji: 'ğŸ‘' }, { en: 'good', jp: '<ruby>è‰¯<rt>ã‚ˆ</rt></ruby>ã„', emoji: 'ğŸ‘Œ' }, { en: 'fun', jp: '<ruby>æ¥½<rt>ãŸã®</rt></ruby>ã—ã„', emoji: 'ğŸ˜†' }, { en: 'cute', jp: 'ã‹ã‚ã„ã„', emoji: 'ğŸ€' }, { en: 'beautiful', jp: '<ruby>ç¾<rt>ã†ã¤ã</rt></ruby>ã—ã„', emoji: 'ğŸŒ¹' }, { en: 'kind', jp: '<ruby>è¦ªåˆ‡<rt>ã—ã‚“ã›ã¤</rt></ruby>', emoji: 'ğŸ¤' }, { en: 'easy', jp: '<ruby>ç°¡å˜<rt>ã‹ã‚“ãŸã‚“</rt></ruby>', emoji: 'â­•' }, { en: 'hard', jp: '<ruby>é›£<rt>ã‚€ãšã‹</rt></ruby>ã—ã„', emoji: 'ğŸ§±' } ] },

            // --- Group 2: ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨æ™‚é–“ (Time) [å¯’è‰²ç³»: Sky/Blue/Indigo] ---
            days: { id: 'days', label: 'ã‚ˆã†ã³ (Days)', color: 'from-sky-400 to-blue-500', words: [ { en: 'Sunday', jp: '<ruby>æ—¥æ›œæ—¥<rt>ã«ã¡ã‚ˆã†ã³</rt></ruby>', emoji: 'â˜€ï¸' }, { en: 'Monday', jp: '<ruby>æœˆæ›œæ—¥<rt>ã’ã¤ã‚ˆã†ã³</rt></ruby>', emoji: 'ğŸŒ™' }, { en: 'Tuesday', jp: '<ruby>ç«æ›œæ—¥<rt>ã‹ã‚ˆã†ã³</rt></ruby>', emoji: 'ğŸ”¥' }, { en: 'Wednesday', jp: '<ruby>æ°´æ›œæ—¥<rt>ã™ã„ã‚ˆã†ã³</rt></ruby>', emoji: 'ğŸ’§' }, { en: 'Thursday', jp: '<ruby>æœ¨æ›œæ—¥<rt>ã‚‚ãã‚ˆã†ã³</rt></ruby>', emoji: 'ğŸŒ³' }, { en: 'Friday', jp: '<ruby>é‡‘æ›œæ—¥<rt>ãã‚“ã‚ˆã†ã³</rt></ruby>', emoji: 'âœ¨' }, { en: 'Saturday', jp: '<ruby>åœŸæ›œæ—¥<rt>ã©ã‚ˆã†ã³</rt></ruby>', emoji: 'â›°ï¸' } ] },
            months: { id: 'months', label: 'ã¤ã (Months)', color: 'from-blue-400 to-indigo-500', words: [ { en: 'January', jp: '<ruby>1æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ' }, { en: 'February', jp: '<ruby>2æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ‘¹' }, { en: 'March', jp: '<ruby>3æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ' }, { en: 'April', jp: '<ruby>4æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸŒ¸' }, { en: 'May', jp: '<ruby>5æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ' }, { en: 'June', jp: '<ruby>6æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'â˜”' }, { en: 'July', jp: '<ruby>7æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ‹' }, { en: 'August', jp: '<ruby>8æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸŒ»' }, { en: 'September', jp: '<ruby>9æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ‘' }, { en: 'October', jp: '<ruby>10æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸƒ' }, { en: 'November', jp: '<ruby>11æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ‚' }, { en: 'December', jp: '<ruby>12æœˆ<rt>ãŒã¤</rt></ruby>', emoji: 'ğŸ„' } ] },
            seasons: { id: 'seasons', label: 'ãã›ã¤ (Seasons)', color: 'from-indigo-400 to-violet-500', words: [ { en: 'spring', jp: '<ruby>æ˜¥<rt>ã¯ã‚‹</rt></ruby>', emoji: 'ğŸŒ¸' }, { en: 'summer', jp: '<ruby>å¤<rt>ãªã¤</rt></ruby>', emoji: 'ğŸŒ»' }, { en: 'autumn', jp: '<ruby>ç§‹<rt>ã‚ã</rt></ruby>', emoji: 'ğŸ' }, { en: 'winter', jp: '<ruby>å†¬<rt>ãµã‚†</rt></ruby>', emoji: 'â›„' } ] },
            time1: { id: 'time1', label: 'ã˜ã‹ã‚“â‘  (Time 1)', color: 'from-violet-400 to-purple-500', words: [ { en: 'time', jp: '<ruby>æ™‚é–“<rt>ã˜ã‹ã‚“</rt></ruby>', emoji: 'â°' }, { en: 'year', jp: '<ruby>å¹´<rt>ã­ã‚“</rt></ruby>', emoji: 'ğŸ“…' }, { en: 'month', jp: '<ruby>æœˆ<rt>ã¤ã</rt></ruby>', emoji: 'ğŸ—“ï¸' }, { en: 'minute', jp: '<ruby>åˆ†<rt>ãµã‚“</rt></ruby>', emoji: 'â±ï¸' }, { en: 'morning', jp: '<ruby>æœ<rt>ã‚ã•</rt></ruby>', emoji: 'ğŸŒ…' }, { en: 'afternoon', jp: '<ruby>æ˜¼<rt>ã²ã‚‹</rt></ruby>ãƒ»<ruby>åˆå¾Œ<rt>ã”ã”</rt></ruby>', emoji: 'â˜€ï¸' }, { en: 'evening', jp: '<ruby>å¤•æ–¹<rt>ã‚†ã†ãŒãŸ</rt></ruby>', emoji: 'ğŸŒ‡' }, { en: 'night', jp: '<ruby>å¤œ<rt>ã‚ˆã‚‹</rt></ruby>', emoji: 'ğŸŒ™' } ] },
            time2: { id: 'time2', label: 'ã˜ã‹ã‚“â‘¡ (Time 2)', color: 'from-purple-400 to-fuchsia-500', words: [ { en: 'today', jp: '<ruby>ä»Šæ—¥<rt>ãã‚‡ã†</rt></ruby>', emoji: 'ğŸ‘‡' }, { en: 'tomorrow', jp: '<ruby>æ˜æ—¥<rt>ã‚ã—ãŸ</rt></ruby>', emoji: 'â¡ï¸' }, { en: 'yesterday', jp: '<ruby>æ˜¨æ—¥<rt>ãã®ã†</rt></ruby>', emoji: 'â¬…ï¸' }, { en: 'now', jp: '<ruby>ä»Š<rt>ã„ã¾</rt></ruby>', emoji: 'â±ï¸' }, { en: 'always', jp: 'ã„ã¤ã‚‚', emoji: 'ğŸ”' }, { en: 'usually', jp: 'ãŸã„ã¦ã„', emoji: 'ğŸ˜Œ' }, { en: 'sometimes', jp: '<ruby>æ™‚ã€…<rt>ã¨ãã©ã</rt></ruby>', emoji: 'ğŸ¤”' }, { en: 'never', jp: '<ruby>æ±º<rt>ã‘ã£</rt></ruby>ã—ã¦ï½ãªã„', emoji: 'ğŸ™…' } ] },

            // --- Group 3: ğŸ« å­¦æ ¡ã¨ç”Ÿæ´» (School & Life) [ç·‘/Tealç³»] ---
            school1: { id: 'school1', label: 'ãŒã£ã“ã†â‘  (School 1)', color: 'from-teal-400 to-emerald-500', words: [ { en: 'school', jp: '<ruby>å­¦æ ¡<rt>ãŒã£ã“ã†</rt></ruby>', emoji: 'ğŸ«' }, { en: 'teacher', jp: '<ruby>å…ˆç”Ÿ<rt>ã›ã‚“ã›ã„</rt></ruby>', emoji: 'ğŸ‘¨â€ğŸ«' }, { en: 'student', jp: '<ruby>ç”Ÿå¾’<rt>ã›ã„ã¨</rt></ruby>', emoji: 'ğŸ’' }, { en: 'friend', jp: '<ruby>å‹é”<rt>ã¨ã‚‚ã ã¡</rt></ruby>', emoji: 'ğŸ¤' }, { en: 'class', jp: '<ruby>æˆæ¥­<rt>ã˜ã‚…ãã‚‡ã†</rt></ruby>', emoji: 'ğŸ””' }, { en: 'classroom', jp: '<ruby>æ•™å®¤<rt>ãã‚‡ã†ã—ã¤</rt></ruby>', emoji: 'ğŸšª' }, { en: 'gym', jp: '<ruby>ä½“è‚²é¤¨<rt>ãŸã„ã„ãã‹ã‚“</rt></ruby>', emoji: 'ğŸŸï¸' }, { en: 'library', jp: '<ruby>å›³æ›¸å®¤<rt>ã¨ã—ã‚‡ã—ã¤</rt></ruby>', emoji: 'ğŸ“š' } ] },
            school2: { id: 'school2', label: 'ãŒã£ã“ã†â‘¡ (School 2)', color: 'from-emerald-400 to-green-500', words: [ { en: 'notebook', jp: 'ãƒãƒ¼ãƒˆ', emoji: 'ğŸ““' }, { en: 'pencil', jp: '<ruby>é‰›ç­†<rt>ãˆã‚“ã´ã¤</rt></ruby>', emoji: 'âœï¸' }, { en: 'eraser', jp: '<ruby>æ¶ˆ<rt>ã‘</rt></ruby>ã—ã‚´ãƒ ', emoji: 'ğŸ§¼' }, { en: 'pen', jp: 'ãƒšãƒ³', emoji: 'ğŸ–Šï¸' }, { en: 'desk', jp: '<ruby>æœº<rt>ã¤ããˆ</rt></ruby>', emoji: 'ğŸ«' }, { en: 'chair', jp: '<ruby>æ¤…å­<rt>ã„ã™</rt></ruby>', emoji: 'ğŸª‘' }, { en: 'textbook', jp: '<ruby>æ•™ç§‘æ›¸<rt>ãã‚‡ã†ã‹ã—ã‚‡</rt></ruby>', emoji: 'ğŸ“–' }, { en: 'homework', jp: '<ruby>å®¿é¡Œ<rt>ã—ã‚…ãã ã„</rt></ruby>', emoji: 'ğŸ“' } ] },
            sports: { id: 'sports', label: 'ã‚¹ãƒãƒ¼ãƒ„ (Sports)', color: 'from-green-400 to-teal-600', words: [ { en: 'baseball', jp: '<ruby>é‡çƒ<rt>ã‚„ãã‚…ã†</rt></ruby>', emoji: 'âš¾' }, { en: 'soccer', jp: 'ã‚µãƒƒã‚«ãƒ¼', emoji: 'âš½' }, { en: 'basketball', jp: 'ãƒã‚¹ã‚±ãƒƒãƒˆãƒœãƒ¼ãƒ«', emoji: 'ğŸ€' }, { en: 'tennis', jp: 'ãƒ†ãƒ‹ã‚¹', emoji: 'ğŸ¾' }, { en: 'volleyball', jp: 'ãƒãƒ¬ãƒ¼ãƒœãƒ¼ãƒ«', emoji: 'ğŸ' }, { en: 'swimming', jp: '<ruby>æ°´æ³³<rt>ã™ã„ãˆã„</rt></ruby>', emoji: 'ğŸŠ' }, { en: 'badminton', jp: 'ãƒãƒ‰ãƒŸãƒ³ãƒˆãƒ³', emoji: 'ğŸ¸' }, { en: 'dance', jp: 'ãƒ€ãƒ³ã‚¹', emoji: 'ğŸ’ƒ' } ] },
            body: { id: 'body', label: 'ã‹ã‚‰ã  (Body)', color: 'from-teal-500 to-cyan-600', words: [ { en: 'head', jp: '<ruby>é ­<rt>ã‚ãŸã¾</rt></ruby>', emoji: 'ğŸ™†' }, { en: 'face', jp: '<ruby>é¡”<rt>ã‹ãŠ</rt></ruby>', emoji: 'â˜º' }, { en: 'eye', jp: '<ruby>ç›®<rt>ã‚</rt></ruby>', emoji: 'ğŸ‘ï¸' }, { en: 'ear', jp: '<ruby>è€³<rt>ã¿ã¿</rt></ruby>', emoji: 'ğŸ‘‚' }, { en: 'nose', jp: '<ruby>é¼»<rt>ã¯ãª</rt></ruby>', emoji: 'ğŸ‘ƒ' }, { en: 'mouth', jp: '<ruby>å£<rt>ãã¡</rt></ruby>', emoji: 'ğŸ‘„' }, { en: 'hand', jp: '<ruby>æ‰‹<rt>ã¦</rt></ruby>', emoji: 'âœ‹' }, { en: 'arm', jp: '<ruby>è…•<rt>ã†ã§</rt></ruby>', emoji: 'ğŸ’ª' }, { en: 'leg', jp: '<ruby>è„š<rt>ã‚ã—</rt></ruby>', emoji: 'ğŸ¦µ' }, { en: 'foot', jp: '<ruby>è¶³<rt>ã‚ã—</rt></ruby>', emoji: 'ğŸ¦¶' }, { en: 'finger', jp: '<ruby>æŒ‡<rt>ã‚†ã³</rt></ruby>', emoji: 'â˜ï¸' } ] },
            clothes: { id: 'clothes', label: 'ãµã (Clothes)', color: 'from-cyan-500 to-sky-600', words: [ { en: 'cap', jp: '<ruby>å¸½å­<rt>ã¼ã†ã—</rt></ruby>ãƒ»ã‚­ãƒ£ãƒƒãƒ—', emoji: 'ğŸ§¢' }, { en: 'hat', jp: '<ruby>å¸½å­<rt>ã¼ã†ã—</rt></ruby>ãƒ»ãƒãƒƒãƒˆ', emoji: 'ğŸ‘’' }, { en: 'T-shirt', jp: 'Tã‚·ãƒ£ãƒ„', emoji: 'ğŸ‘•' }, { en: 'shirt', jp: 'ã‚·ãƒ£ãƒ„', emoji: 'ğŸ‘”' }, { en: 'shoes', jp: '<ruby>é´<rt>ãã¤</rt></ruby>', emoji: 'ğŸ‘Ÿ' }, { en: 'socks', jp: '<ruby>é´ä¸‹<rt>ãã¤ã—ãŸ</rt></ruby>', emoji: 'ğŸ§¦' }, { en: 'bag', jp: 'ã‚«ãƒãƒ³', emoji: 'ğŸ’' }, { en: 'umbrella', jp: '<ruby>å‚˜<rt>ã‹ã•</rt></ruby>', emoji: 'â˜‚ï¸' } ] },
            drinks: { id: 'drinks', label: 'ã®ã¿ã‚‚ã® (Drinks)', color: 'from-sky-500 to-blue-600', words: [ { en: 'milk', jp: '<ruby>ç‰›ä¹³<rt>ãã‚…ã†ã«ã‚…ã†</rt></ruby>', emoji: 'ğŸ¥›' }, { en: 'water', jp: '<ruby>æ°´<rt>ã¿ãš</rt></ruby>', emoji: 'ğŸ’§' }, { en: 'juice', jp: 'ã‚¸ãƒ¥ãƒ¼ã‚¹', emoji: 'ğŸ¹' }, { en: 'tea', jp: '<ruby>ãŠèŒ¶<rt>ã¡ã‚ƒ</rt></ruby>', emoji: 'ğŸµ' }, { en: 'coffee', jp: 'ã‚³ãƒ¼ãƒ’ãƒ¼', emoji: 'â˜•' } ] },

            // --- Group 4: ğŸŒ ã„ã‚ã„ã‚ãªè¨€è‘‰ (World & Actions) [Purple/Pinkç³»] ---
            verbs1: { id: 'verbs1', label: 'ã†ã”ãâ‘  (Verbs 1)', color: 'from-purple-400 to-fuchsia-500', words: [ { en: 'play', jp: '<ruby>éŠ<rt>ã‚ã</rt></ruby>ã¶ãƒ»ã™ã‚‹', emoji: 'ğŸ®' }, { en: 'go', jp: '<ruby>è¡Œ<rt>ã„</rt></ruby>ã', emoji: 'ğŸš¶' }, { en: 'come', jp: '<ruby>æ¥<rt>ã</rt></ruby>ã‚‹', emoji: 'ğŸƒ' }, { en: 'swim', jp: '<ruby>æ³³<rt>ãŠã‚ˆ</rt></ruby>ã', emoji: 'ğŸŠ' }, { en: 'run', jp: '<ruby>èµ°<rt>ã¯ã—</rt></ruby>ã‚‹', emoji: 'ğŸ’¨' }, { en: 'make', jp: '<ruby>ä½œ<rt>ã¤ã</rt></ruby>ã‚‹', emoji: 'ğŸ”¨' }, { en: 'use', jp: '<ruby>ä½¿<rt>ã¤ã‹</rt></ruby>ã†', emoji: 'ğŸ’»' }, { en: 'wash', jp: '<ruby>æ´—<rt>ã‚ã‚‰</rt></ruby>ã†', emoji: 'ğŸ§¼' }, { en: 'clean', jp: '<ruby>æƒé™¤<rt>ãã†ã˜</rt></ruby>ã™ã‚‹', emoji: 'ğŸ§¹' } ] },
            verbs2: { id: 'verbs2', label: 'ã†ã”ãâ‘¡ (Verbs 2)', color: 'from-fuchsia-400 to-pink-500', words: [ { en: 'eat', jp: '<ruby>é£Ÿ<rt>ãŸ</rt></ruby>ã¹ã‚‹', emoji: 'ğŸ½ï¸' }, { en: 'drink', jp: '<ruby>é£²<rt>ã®</rt></ruby>ã‚€', emoji: 'ğŸ¥¤' }, { en: 'cook', jp: '<ruby>æ–™ç†<rt>ã‚Šã‚‡ã†ã‚Š</rt></ruby>ã™ã‚‹', emoji: 'ğŸ³' }, { en: 'study', jp: '<ruby>å‹‰å¼·<rt>ã¹ã‚“ãã‚‡ã†</rt></ruby>ã™ã‚‹', emoji: 'âœï¸' }, { en: 'watch', jp: '<ruby>è¦‹<rt>ã¿</rt></ruby>ã‚‹', emoji: 'ğŸ“º' }, { en: 'listen', jp: '<ruby>è<rt>ã</rt></ruby>ã', emoji: 'ğŸ§' }, { en: 'like', jp: '<ruby>å¥½<rt>ã™</rt></ruby>ã', emoji: 'â¤ï¸' }, { en: 'have', jp: '<ruby>æŒ<rt>ã‚‚</rt></ruby>ã£ã¦ã„ã‚‹', emoji: 'ğŸ¤²' }, { en: 'want', jp: '<ruby>æ¬²<rt>ã»</rt></ruby>ã—ã„', emoji: 'ğŸ¥º' } ] },
            nature: { id: 'nature', label: 'ã—ãœã‚“ (Nature)', color: 'from-pink-400 to-rose-500', words: [ { en: 'sun', jp: '<ruby>å¤ªé™½<rt>ãŸã„ã‚ˆã†</rt></ruby>', emoji: 'â˜€ï¸' }, { en: 'moon', jp: '<ruby>æœˆ<rt>ã¤ã</rt></ruby>', emoji: 'ğŸŒ•' }, { en: 'sky', jp: '<ruby>ç©º<rt>ãã‚‰</rt></ruby>', emoji: 'ğŸŒŒ' }, { en: 'rain', jp: '<ruby>é›¨<rt>ã‚ã‚</rt></ruby>', emoji: 'â˜”' }, { en: 'snow', jp: '<ruby>é›ª<rt>ã‚†ã</rt></ruby>', emoji: 'â›„' }, { en: 'cloud', jp: '<ruby>é›²<rt>ãã‚‚</rt></ruby>', emoji: 'â˜ï¸' }, { en: 'wind', jp: '<ruby>é¢¨<rt>ã‹ãœ</rt></ruby>', emoji: 'ğŸƒ' }, { en: 'river', jp: '<ruby>å·<rt>ã‹ã‚</rt></ruby>', emoji: 'ğŸï¸' }, { en: 'mountain', jp: '<ruby>å±±<rt>ã‚„ã¾</rt></ruby>', emoji: 'â›°ï¸' }, { en: 'sea', jp: '<ruby>æµ·<rt>ã†ã¿</rt></ruby>', emoji: 'ğŸŒŠ' }, { en: 'flower', jp: '<ruby>èŠ±<rt>ã¯ãª</rt></ruby>', emoji: 'ğŸŒ·' }, { en: 'tree', jp: '<ruby>æœ¨<rt>ã</rt></ruby>', emoji: 'ğŸŒ³' } ] },
            life1: { id: 'life1', label: 'ã›ã„ã‹ã¤â‘  (Life 1)', color: 'from-rose-400 to-red-500', words: [ { en: 'house', jp: '<ruby>å®¶<rt>ã„ãˆ</rt></ruby>', emoji: 'ğŸ ' }, { en: 'home', jp: '<ruby>å®¶åº­<rt>ã‹ã¦ã„</rt></ruby>ãƒ»<ruby>å®¶<rt>ã†ã¡</rt></ruby>', emoji: 'ğŸ¡' }, { en: 'room', jp: '<ruby>éƒ¨å±‹<rt>ã¸ã‚„</rt></ruby>', emoji: 'ğŸšª' }, { en: 'kitchen', jp: '<ruby>å°æ‰€<rt>ã ã„ã©ã“ã‚</rt></ruby>', emoji: 'ğŸ³' }, { en: 'bath', jp: '<ruby>ãŠé¢¨å‘‚<rt>ãµã‚</rt></ruby>', emoji: 'ğŸ›' }, { en: 'park', jp: '<ruby>å…¬åœ’<rt>ã“ã†ãˆã‚“</rt></ruby>', emoji: 'ğŸï¸' }, { en: 'station', jp: '<ruby>é§…<rt>ãˆã</rt></ruby>', emoji: 'ğŸš‰' }, { en: 'store', jp: '<ruby>åº—<rt>ã¿ã›</rt></ruby>', emoji: 'ğŸª' } ] },
            life2: { id: 'life2', label: 'ã›ã„ã‹ã¤â‘¡ (Life 2)', color: 'from-red-400 to-orange-500', words: [ { en: 'bed', jp: 'ãƒ™ãƒƒãƒ‰', emoji: 'ğŸ›ï¸' }, { en: 'computer', jp: 'ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿', emoji: 'ğŸ’»' }, { en: 'TV', jp: 'ãƒ†ãƒ¬ãƒ“', emoji: 'ğŸ“º' }, { en: 'phone', jp: '<ruby>é›»è©±<rt>ã§ã‚“ã‚</rt></ruby>', emoji: 'â˜ï¸' }, { en: 'money', jp: '<ruby>ãŠé‡‘<rt>ã‹ã­</rt></ruby>', emoji: 'ğŸ’´' }, { en: 'present', jp: 'ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ', emoji: 'ğŸ' } ] },
            countries: { id: 'countries', label: 'ãã« (Countries)', color: 'from-orange-400 to-amber-500', words: [ { en: 'Japan', jp: '<ruby>æ—¥æœ¬<rt>ã«ã»ã‚“</rt></ruby>', emoji: 'ğŸ‡¯ğŸ‡µ' }, { en: 'America', jp: 'ã‚¢ãƒ¡ãƒªã‚«', emoji: 'ğŸ‡ºğŸ‡¸' }, { en: 'Canada', jp: 'ã‚«ãƒŠãƒ€', emoji: 'ğŸ‡¨ğŸ‡¦' }, { en: 'Australia', jp: 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢', emoji: 'ğŸ‡¦ğŸ‡º' }, { en: 'China', jp: '<ruby>ä¸­å›½<rt>ã¡ã‚…ã†ã”ã</rt></ruby>', emoji: 'ğŸ‡¨ğŸ‡³' }, { en: 'Korea', jp: '<ruby>éŸ“å›½<rt>ã‹ã‚“ã“ã</rt></ruby>', emoji: 'ğŸ‡°ğŸ‡·' }, { en: 'Brazil', jp: 'ãƒ–ãƒ©ã‚¸ãƒ«', emoji: 'ğŸ‡§ğŸ‡·' } ] },

            // --- Group 5: ğŸ”¥ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ (Challenge) [Dark/Richç³»] ---
            num2: { id: 'num2', label: 'ã™ã†ã˜â‘¡ (11-20)', color: 'from-rose-500 to-pink-600', words: [ { en: 'eleven', jp: '11', emoji: 'ğŸ•š' }, { en: 'twelve', jp: '12', emoji: 'ğŸ•›' }, { en: 'thirteen', jp: '13', emoji: '1ï¸âƒ£3ï¸âƒ£' }, { en: 'fourteen', jp: '14', emoji: '1ï¸âƒ£4ï¸âƒ£' }, { en: 'fifteen', jp: '15', emoji: '1ï¸âƒ£5ï¸âƒ£' }, { en: 'sixteen', jp: '16', emoji: '1ï¸âƒ£6ï¸âƒ£' }, { en: 'seventeen', jp: '17', emoji: '1ï¸âƒ£7ï¸âƒ£' }, { en: 'eighteen', jp: '18', emoji: '1ï¸âƒ£8ï¸âƒ£' }, { en: 'nineteen', jp: '19', emoji: '1ï¸âƒ£9ï¸âƒ£' }, { en: 'twenty', jp: '20', emoji: '2ï¸âƒ£0ï¸âƒ£' } ] },
            shapes: { id: 'shapes', label: 'ã‹ãŸã¡ (Shapes)', color: 'from-pink-500 to-fuchsia-600', words: [ { en: 'circle', jp: '<ruby>å††<rt>ãˆã‚“</rt></ruby>', emoji: 'â­•' }, { en: 'triangle', jp: '<ruby>ä¸‰è§’å½¢<rt>ã•ã‚“ã‹ãã‘ã„</rt></ruby>', emoji: 'ğŸ”º' }, { en: 'square', jp: '<ruby>æ­£æ–¹å½¢<rt>ã›ã„ã»ã†ã‘ã„</rt></ruby>ãƒ»<ruby>å››è§’<rt>ã—ã‹ã</rt></ruby>', emoji: 'ğŸŸ¥' }, { en: 'star', jp: '<ruby>æ˜Ÿ<rt>ã»ã—</rt></ruby>', emoji: 'â­' }, { en: 'heart', jp: 'ãƒãƒ¼ãƒˆ', emoji: 'â¤ï¸' } ] },
            order: { id: 'order', label: 'ã˜ã‚…ã‚“ã°ã‚“ (Order)', color: 'from-fuchsia-500 to-purple-600', words: [ { en: 'first', jp: '<ruby>1ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: 'ğŸ¥‡' }, { en: 'second', jp: '<ruby>2ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: 'ğŸ¥ˆ' }, { en: 'third', jp: '<ruby>3ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: 'ğŸ¥‰' }, { en: 'fourth', jp: '<ruby>4ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: '4ï¸âƒ£' }, { en: 'fifth', jp: '<ruby>5ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: '5ï¸âƒ£' }, { en: 'sixth', jp: '<ruby>6ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: '6ï¸âƒ£' }, { en: 'seventh', jp: '<ruby>7ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: '7ï¸âƒ£' }, { en: 'eighth', jp: '<ruby>8ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: '8ï¸âƒ£' }, { en: 'ninth', jp: '<ruby>9ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: '9ï¸âƒ£' }, { en: 'tenth', jp: '<ruby>10ç•ªç›®<rt>ã°ã‚“ã‚</rt></ruby>', emoji: 'ğŸ”Ÿ' } ] },
            adj1: { id: 'adj1', label: 'ã‹ãŸã¡ãƒ»ã‚ˆã†ã™ (State)', color: 'from-purple-500 to-indigo-600', words: [ { en: 'big', jp: '<ruby>å¤§<rt>ãŠãŠ</rt></ruby>ãã„', emoji: 'ğŸ˜' }, { en: 'small', jp: '<ruby>å°<rt>ã¡ã„</rt></ruby>ã•ã„', emoji: 'ğŸœ' }, { en: 'long', jp: '<ruby>é•·<rt>ãªãŒ</rt></ruby>ã„', emoji: 'ğŸ' }, { en: 'short', jp: '<ruby>çŸ­<rt>ã¿ã˜ã‹</rt></ruby>ã„', emoji: 'ğŸ›' }, { en: 'new', jp: '<ruby>æ–°<rt>ã‚ãŸã‚‰</rt></ruby>ã—ã„', emoji: 'âœ¨' }, { en: 'old', jp: '<ruby>å¤<rt>ãµã‚‹</rt></ruby>ã„', emoji: 'ğŸšï¸' }, { en: 'hot', jp: '<ruby>æš‘<rt>ã‚ã¤</rt></ruby>ã„', emoji: 'ğŸ¥µ' }, { en: 'cold', jp: '<ruby>å¯’<rt>ã•ã‚€</rt></ruby>ã„ãƒ»<ruby>å†·<rt>ã¤ã‚</rt></ruby>ãŸã„', emoji: 'ğŸ¥¶' } ] },
            questions: { id: 'questions', label: 'ã—ã¤ã‚‚ã‚“ (Questions)', color: 'from-indigo-500 to-blue-600', words: [ { en: 'what', jp: '<ruby>ä½•<rt>ãªã«</rt></ruby>', emoji: 'â“' }, { en: 'who', jp: '<ruby>èª°<rt>ã ã‚Œ</rt></ruby>', emoji: 'ğŸ‘¤' }, { en: 'where', jp: 'ã©ã“', emoji: 'ğŸ“' }, { en: 'when', jp: 'ã„ã¤', emoji: 'â°' }, { en: 'which', jp: 'ã©ã¡ã‚‰', emoji: 'ğŸ‘ˆ' }, { en: 'how', jp: 'ã©ã†ã‚„ã£ã¦', emoji: 'ğŸ› ï¸' }, { en: 'whose', jp: '<ruby>èª°<rt>ã ã‚Œ</rt></ruby>ã®', emoji: 'ğŸ·ï¸' } ] },
        };

        // --- ã‚«ãƒ†ã‚´ãƒªã‚°ãƒ«ãƒ¼ãƒ—å®šç¾©ï¼ˆãƒ›ãƒ¼ãƒ ç”»é¢ã®æ•´ç†ç”¨ï¼‰ ---
        const CATEGORY_GROUPS = [
            {
                title: "ğŸ‘‘ ã¯ã˜ã‚ã‚ˆã† (Basics)",
                color: "text-amber-600",
                bg: "bg-orange-50 border-orange-200",
                ids: ['num1', 'colors', 'animals', 'food', 'family', 'adj2']
            },
            {
                title: "ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ã˜ã‹ã‚“ (Time)",
                color: "text-blue-600",
                bg: "bg-blue-50 border-blue-200",
                ids: ['days', 'months', 'seasons', 'time1', 'time2']
            },
            {
                title: "ğŸ« ãŒã£ã“ã†ã¨ã›ã„ã‹ã¤ (School & Life)",
                color: "text-teal-600",
                bg: "bg-teal-50 border-teal-200",
                ids: ['school1', 'school2', 'sports', 'body', 'clothes', 'drinks']
            },
            {
                title: "ğŸŒ ã„ã‚ã„ã‚ãªã“ã¨ã° (World & Actions)",
                color: "text-purple-600",
                bg: "bg-purple-50 border-purple-200",
                ids: ['verbs1', 'verbs2', 'nature', 'life1', 'life2', 'countries']
            },
            {
                title: "ğŸ”¥ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ (Challenge)",
                color: "text-rose-600",
                bg: "bg-rose-50 border-rose-200",
                ids: ['num2', 'shapes', 'order', 'adj1', 'questions']
            }
        ];

        const ICON_OPTIONS = ['ğŸ¶', 'ğŸ±', 'ğŸ°', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸš—', 'ğŸš€', 'âœˆï¸', 'ğŸš‚', 'ğŸš“', 'ğŸš‘', 'âš½', 'âš¾', 'ğŸ€', 'ğŸ¾', 'ğŸ', 'ğŸ“', 'ğŸ’', 'ğŸ‡', 'ğŸ‰', 'â˜€ï¸', 'ğŸŒ™', 'ğŸŒŸ', 'â„ï¸', 'ğŸŒˆ', 'ğŸ‘‘', 'ğŸ’', 'ğŸ€', 'ğŸµ'];
        const STAMP_OPTIONS = [
            'ğŸ’–', 'ğŸ€', 'ğŸŒ¸', 'ğŸ­', 'ğŸ¦„', 'ğŸ°', 'ğŸ£', 'ğŸ¦‹', 'ğŸŒ·', 'ğŸ“',
            'ğŸ”¥', 'âš¡', 'ğŸš€', 'ğŸ¦–', 'ğŸ¦', 'ğŸ¦…', 'ğŸ‰', 'ğŸ®', 'âš½', 'ğŸï¸',
            'ğŸ‘‘', 'ğŸ’', 'ğŸ†', 'ğŸ’¯', 'ğŸŒŸ', 'ğŸŒˆ', 'ğŸŠ', 'ğŸ¥‡', 'ğŸ¦¸', 'ğŸ§',
            'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸœ', 'ğŸ£', 'ğŸ™', 'ğŸ°', 'ğŸ©', 'ğŸ¦', 'ğŸª', 'ğŸ«',
            'ğŸ¶', 'ğŸ±', 'ğŸ¹', 'ğŸ¦Š', 'ğŸ¼', 'ğŸ¨', 'ğŸ§', 'ğŸ¢', 'ğŸ¬', 'ğŸ³', 'ğŸ˜'
        ];
        const COLOR_OPTIONS = [
            { label: 'Blue', class: 'bg-blue-100 text-blue-700' },
            { label: 'Pink', class: 'bg-pink-100 text-pink-700' },
            { label: 'Amber', class: 'bg-amber-100 text-amber-700' },
            { label: 'Green', class: 'bg-green-100 text-green-700' },
            { label: 'Purple', class: 'bg-purple-100 text-purple-700' },
            { label: 'Teal', class: 'bg-teal-100 text-teal-700' },
        ];

        // Version 6 (ãã®ã¾ã¾ä½¿ç”¨)
        const DATA_KEY = 'spelling_game_data_v6';
        const USERS_KEY = 'spelling_game_users_v6';
        const HISTORY_LIMIT = 50;

        // --- 2. çŠ¶æ…‹ç®¡ç† (Global State) ---
        
        let state = {
            users: [],
            allUsersData: {},
            currentUserId: null,
            screen: 'userSelect', // userSelect, userEdit, home, history, game, result, stampBook, stampSelect
            isSoundOn: true,
            
            // Edit User State
            editingUser: {}, // { id, name, icon, color }

            // Game State
            currentCategory: null,
            questionIndex: 0,
            poolLetters: [], // { char, id }
            answerSlots: [], // { char, id } or null
            isCorrect: false,
            showHint: false,
            usedHintInSession: false,
            hasErrorInSession: false,

            // Result State
            resultInfo: null // { isPerfect, canGetStamp }
        };

        // --- 3. éŸ³å£°ãƒ»åŠ¹æœéŸ³ã‚¨ãƒ³ã‚¸ãƒ³ ---

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = new AudioContext();

        function initAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        function playTone(type) {
            if (!state.isSoundOn) return;
            initAudio();

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            switch (type) {
                case 'tap':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(800, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.08);
                    gain.gain.setValueAtTime(0.15, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
                    osc.start(now);
                    osc.stop(now + 0.08);
                    break;
                case 'remove':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(400, now);
                    osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                    break;
                case 'hint':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(1200, now);
                    osc.frequency.exponentialRampToValueAtTime(800, now + 0.2);
                    gain.gain.setValueAtTime(0.05, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                    break;
                case 'correct':
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523.25, now); 
                    osc.frequency.setValueAtTime(659.25, now + 0.1); 
                    osc.frequency.setValueAtTime(783.99, now + 0.2); 
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.6);
                    osc.start(now);
                    osc.stop(now + 0.6);
                    break;
                case 'error':
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                    gain.gain.setValueAtTime(0.2, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.2);
                    osc.start(now);
                    osc.stop(now + 0.2);
                    break;
                case 'complete': // é€šå¸¸ã‚¯ãƒªã‚¢
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(523.25, now); 
                    osc.frequency.setValueAtTime(659.25, now + 0.15); 
                    osc.frequency.setValueAtTime(783.99, now + 0.30); 
                    osc.frequency.setValueAtTime(1046.50, now + 0.45); 
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 0.8);
                    osc.start(now);
                    osc.stop(now + 0.8);
                    break;
                case 'perfect': // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(523.25, now); 
                    osc.frequency.setValueAtTime(523.25, now + 0.12); 
                    osc.frequency.setValueAtTime(523.25, now + 0.24); 
                    osc.frequency.setValueAtTime(783.99, now + 0.36); 
                    osc.frequency.setValueAtTime(659.25, now + 0.60); 
                    osc.frequency.setValueAtTime(783.99, now + 0.72); 
                    osc.frequency.setValueAtTime(1046.50, now + 0.84); 
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 2.0);
                    osc.start(now);
                    osc.stop(now + 2.0);
                    break;
                case 'crown': // ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆ
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(1046.50, now); 
                    osc.frequency.setValueAtTime(1318.51, now + 0.1); 
                    osc.frequency.setValueAtTime(1567.98, now + 0.2); 
                    osc.frequency.setValueAtTime(2093.00, now + 0.4); 
                    gain.gain.setValueAtTime(0.1, now);
                    gain.gain.linearRampToValueAtTime(0, now + 1.0);
                    osc.start(now);
                    osc.stop(now + 1.0);
                    break;
                case 'stamp':
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(200, now);
                    osc.frequency.exponentialRampToValueAtTime(600, now + 0.1);
                    gain.gain.setValueAtTime(0.5, now);
                    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                    osc.start(now);
                    osc.stop(now + 0.15);
                    break;
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            window.speechSynthesis.speak(utterance);
        }

        // --- 4. ãƒ­ã‚¸ãƒƒã‚¯ & ãƒ˜ãƒ«ãƒ‘ãƒ¼ ---

        function initData() {
            const savedUsers = localStorage.getItem(USERS_KEY);
            if (savedUsers) {
                state.users = JSON.parse(savedUsers);
            }
            const savedData = localStorage.getItem(DATA_KEY);
            if (savedData) {
                state.allUsersData = JSON.parse(savedData);
            }
        }

        function saveUsers() {
            localStorage.setItem(USERS_KEY, JSON.stringify(state.users));
        }

        function saveData() {
            localStorage.setItem(DATA_KEY, JSON.stringify(state.allUsersData));
        }

        function getSlotSizeClass(wordLength) {
            if (wordLength >= 8) return { box: "w-8 h-12 sm:w-12 sm:h-16", text: "text-3xl sm:text-5xl leading-relaxed pb-2" };
            if (wordLength >= 6) return { box: "w-10 h-14 sm:w-14 sm:h-20", text: "text-4xl sm:text-6xl leading-relaxed pb-2" };
            return { box: "w-14 h-16 sm:w-16 sm:h-24", text: "text-5xl sm:text-7xl leading-relaxed pb-3" };
        }

        function updateScreen(screenName) {
            state.screen = screenName;
            render();
        }

        // --- 5. ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•° (View) ---

        const app = document.getElementById('app');

        function render() {
            app.innerHTML = '';
            
            // Common User Data
            const currentUser = state.users.find(u => u.id === state.currentUserId);
            const userProgress = (state.currentUserId && state.allUsersData[state.currentUserId]) 
                ? state.allUsersData[state.currentUserId].progress 
                : {};

            if (state.screen === 'userSelect') {
                renderUserSelect();
            } else if (state.screen === 'userEdit') {
                renderUserEdit();
            } else if (state.screen === 'home') {
                renderHome(currentUser, userProgress);
            } else if (state.screen === 'stampBook') {
                renderStampBook(userProgress);
            } else if (state.screen === 'history') {
                renderHistory();
            } else if (state.screen === 'game') {
                renderGame(currentUser);
            } else if (state.screen === 'result') {
                renderResult(currentUser, userProgress);
            } else if (state.screen === 'stampSelect') {
                renderStampSelect();
            }

            // Lucideã‚¢ã‚¤ã‚³ãƒ³ã®å†æç”»
            lucide.createIcons();
        }

        function renderUserSelect() {
            let html = `
            <div class="min-h-screen bg-slate-50 p-4 flex items-center justify-center w-full">
                <div class="max-w-md w-full">
                    <header class="mb-10 text-center relative">
                        <div class="absolute right-0 top-0">
                            <button onclick="toggleSound()" class="p-2 rounded-full bg-slate-200 hover:bg-slate-300 text-slate-600 transition-colors">
                                <i data-lucide="${state.isSoundOn ? 'volume-2' : 'volume-x'}" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <h1 class="text-3xl font-bold text-indigo-600 mb-2 flex items-center justify-center gap-2 pt-2">
                            <i data-lucide="sparkles" class="w-8 h-8 text-yellow-400 fill-yellow-400"></i>
                            English Puzzle
                        </h1>
                        <p class="text-slate-500 font-bold">ã ã‚ŒãŒ ã‚ãã¶ï¼Ÿ</p>
                    </header>
                    <div class="grid gap-4">`;

            state.users.forEach(user => {
                html += `
                <div class="relative group">
                    <button onclick="selectUser('${user.id}')" class="w-full p-4 pr-12 rounded-3xl shadow-md hover:shadow-lg transition-all transform hover:-translate-y-1 text-left ${user.color} flex items-center gap-4 border-b-4 border-black/10 active:border-b-0 active:translate-y-1">
                        <div class="text-4xl bg-white/50 w-16 h-16 rounded-full flex items-center justify-center shadow-inner flex-shrink-0">
                            ${user.icon}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-xl font-bold truncate">${user.name}</div>
                            <div class="text-xs opacity-80 font-bold mt-1">Let's Play!</div>
                        </div>
                        <i data-lucide="arrow-right" class="w-6 h-6 opacity-60"></i>
                    </button>
                    <button onclick="deleteUser('${user.id}')" class="absolute -top-2 -right-2 p-2 bg-white text-slate-400 hover:text-red-500 rounded-full shadow-sm border border-slate-200 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>`;
            });

            if (state.users.length < 3) {
                html += `
                <button onclick="startEditUser()" class="w-full p-6 rounded-3xl border-4 border-dashed border-slate-300 text-slate-400 flex flex-col items-center justify-center gap-2 hover:bg-slate-100 hover:border-slate-400 transition-all group">
                    <div class="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center group-hover:bg-slate-300 transition-colors">
                        <i data-lucide="plus" class="w-6 h-6"></i>
                    </div>
                    <span class="font-bold">ã‚ãŸã‚‰ã—ã ã¤ãã‚‹</span>
                </button>`;
            } else {
                html += `<p class="text-center text-xs text-slate-400 mt-2 font-bold">â€» 3ã«ã‚“ ã¾ã§ ã¤ãã‚Œã‚‹ã‚ˆ</p>`;
            }

            html += `</div></div></div>`;
            app.innerHTML = html;
        }

        function renderUserEdit() {
            const u = state.editingUser;
            let html = `
            <div class="min-h-screen bg-slate-50 p-4 flex items-center justify-center w-full">
                <div class="max-w-md w-full bg-white rounded-3xl p-6 shadow-xl border-4 border-slate-100">
                    <h2 class="text-2xl font-bold text-center mb-6 text-slate-700">${u.id ? 'ã¸ã‚“ã—ã‚…ã†' : 'ã‚ãŸã‚‰ã—ã ã¤ãã‚‹'}</h2>
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">ãªã¾ãˆ</label>
                            <input type="text" id="userNameInput" value="${u.name || ''}" class="w-full text-2xl font-bold p-3 rounded-xl border-2 border-slate-200 focus:border-indigo-400 outline-none text-center" placeholder="ãªã¾ãˆã‚’ã„ã‚Œã¦ã­" oninput="updateEditingName(this.value)">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">ã‚¢ã‚¤ã‚³ãƒ³</label>
                            <div class="flex flex-wrap gap-2 justify-center max-h-40 overflow-y-auto p-2 bg-slate-50 rounded-xl border border-slate-100">
                                ${ICON_OPTIONS.map(icon => `
                                    <button onclick="updateEditingIcon('${icon}')" class="w-12 h-12 text-3xl flex items-center justify-center rounded-lg transition-all ${u.icon === icon ? 'bg-white shadow-md scale-110 border-2 border-indigo-400' : 'hover:bg-white hover:shadow-sm'}">
                                        ${icon}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-400 mb-2">ã„ã‚</label>
                            <div class="flex flex-wrap gap-3 justify-center">
                                ${COLOR_OPTIONS.map(c => `
                                    <button onclick="updateEditingColor('${c.class}')" class="w-10 h-10 rounded-full border-2 ${c.class.split(' ')[0]} ${u.color === c.class ? 'ring-4 ring-offset-2 ring-indigo-200 scale-110 border-indigo-500' : 'border-transparent opacity-70'}"></button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button onclick="updateScreen('userSelect'); playTone('tap')" class="flex-1 py-3 rounded-xl bg-slate-200 text-slate-600 font-bold">ã‚„ã‚ã‚‹</button>
                            <button id="saveUserBtn" onclick="saveUserEdit()" class="flex-1 py-3 rounded-xl text-white font-bold transition-all ${u.name ? 'bg-indigo-500 hover:bg-indigo-600 shadow-md transform hover:-translate-y-1' : 'bg-slate-300'}" ${!u.name ? 'disabled' : ''}>ã‘ã£ã¦ã„</button>
                        </div>
                    </div>
                </div>
            </div>`;
            app.innerHTML = html;
        }

        function renderHome(user, progress) {
            let html = `
            <div class="min-h-screen bg-slate-50 p-4 w-full">
                <div class="max-w-md mx-auto pt-2">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="updateScreen('userSelect'); playTone('tap')" class="flex items-center gap-2 px-3 py-2 bg-white rounded-full text-slate-500 font-bold shadow-sm hover:bg-slate-100">
                            <i data-lucide="arrow-left" class="w-5 h-5"></i> ã‚‚ã©ã‚‹
                        </button>
                        <div class="flex items-center gap-2 px-4 py-2 rounded-full font-bold text-sm ${user.color}">
                            <span>${user.icon}</span><span>${user.name}</span>
                        </div>
                    </div>

                    <header class="mb-6 text-center">
                        <button onclick="updateScreen('stampBook'); playTone('tap')" class="w-full mb-8 p-6 rounded-3xl bg-gradient-to-br from-amber-50 to-orange-100 border-4 border-amber-200 shadow-lg flex items-center gap-4 hover:border-amber-300 hover:scale-[1.02] transition-all group relative overflow-hidden">
                            <div class="absolute -right-6 -top-6 w-32 h-32 bg-yellow-300 rounded-full opacity-20 blur-2xl"></div>
                            <div class="text-left flex-1 relative z-10 pl-2">
                                <div class="text-2xl font-black text-amber-800 drop-shadow-sm">ğŸ‘‘ã‚¹ã‚¿ãƒ³ãƒ—ã¡ã‚‡ã†ğŸ‘‘</div>
                                <div class="text-sm text-amber-700 font-bold mt-1 leading-tight flex items-center gap-1">
                                    <i data-lucide="crown" class="w-4 h-4 fill-amber-600"></i>
                                    3å› ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆã§ã‚²ãƒƒãƒˆï¼
                                </div>
                            </div>
                            <div class="bg-white p-2 rounded-full shadow-sm">
                                <i data-lucide="arrow-right" class="w-6 h-6 text-amber-500"></i>
                            </div>
                        </button>
                        <h2 class="text-2xl font-bold text-slate-700 flex items-center justify-center gap-2">
                            <i data-lucide="grid" class="w-6 h-6 text-indigo-400"></i> ã©ã‚Œã§ ã‚ãã¶ï¼Ÿ
                        </h2>
                    </header>

                    <div class="space-y-8 mb-12">`;

            CATEGORY_GROUPS.forEach(group => {
                html += `
                <div>
                    <div class="flex items-center gap-2 mb-3 px-2">
                        <span class="text-lg font-bold ${group.color}">${group.title}</span>
                        <div class="h-1 flex-1 bg-slate-100 rounded-full"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">`;
                
                group.ids.forEach(catId => {
                    const cat = DATA[catId];
                    const p = progress[cat.id] || { perfectCount: 0, hasCrown: false };
                    const remainingForCrown = Math.max(0, 3 - p.perfectCount);
                    
                    html += `
                    <button onclick="startCategory('${cat.id}')" class="relative w-full p-4 rounded-2xl shadow-sm hover:shadow-md transition-all transform hover:-translate-y-1 text-left bg-gradient-to-r ${cat.color} text-white group overflow-hidden h-full border-b-4 border-black/10 active:border-b-0 active:translate-y-1">
                        <div class="flex justify-between items-start relative z-10 h-full">
                            <div class="flex-1 min-w-0">
                                <span class="text-lg font-bold flex flex-wrap items-center gap-1 leading-tight mb-1">
                                    ${cat.label.split('(')[0]}
                                    ${p.stamp ? `<span class="text-xl animate-shine drop-shadow-sm ml-1">ğŸ‘‘</span>` : ''}
                                </span>
                                <div class="text-xs opacity-90 font-medium flex flex-wrap items-center gap-1">
                                    <span class="bg-black/20 px-1.5 py-0.5 rounded-md whitespace-nowrap">${cat.words.length}ã‚‚ã‚“</span>
                                    ${!p.stamp && p.perfectCount > 0 ? `<span class="bg-yellow-400/90 text-yellow-900 px-1.5 py-0.5 rounded-full whitespace-nowrap font-bold text-[10px]">ã‚ã¨${remainingForCrown}ã‹ã„</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="absolute -right-2 -bottom-2 opacity-20 text-6xl pointer-events-none filter grayscale brightness-200">${cat.words[0].emoji}</div>
                    </button>`;
                });
                
                html += `</div></div>`;
            });

            html += `
                    </div>
                    <div class="text-center pb-8 border-t border-slate-200 pt-8">
                        <button onclick="updateScreen('history'); playTone('tap')" class="inline-flex items-center gap-2 px-6 py-3 bg-white text-slate-500 rounded-xl font-bold shadow-sm border-2 border-slate-200 hover:bg-slate-50 transition-colors text-sm">
                            <i data-lucide="history" class="w-4 h-4"></i> ãã‚ãã‚’ ã¿ã‚‹
                        </button>
                    </div>
                </div>
            </div>`;
            app.innerHTML = html;
        }

        function renderStampBook(progress) {
            // é›†ã‚ãŸã‚¹ã‚¿ãƒ³ãƒ—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            const totalStamps = Object.values(DATA).length;
            const collectedStamps = Object.values(DATA).filter(cat => progress[cat.id]?.stamp).length;
            const percentage = Math.round((collectedStamps / totalStamps) * 100);

            let html = `
            <div class="min-h-screen bg-amber-50 p-4 w-full">
                <div class="max-w-md mx-auto pt-2">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="updateScreen('home'); playTone('tap')" class="p-2 bg-white rounded-full shadow-sm text-amber-400 hover:text-amber-600 transition-colors">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-xl font-bold text-amber-900 flex items-center gap-2">
                            ğŸ‘‘ã‚¹ã‚¿ãƒ³ãƒ—ã¡ã‚‡ã†ğŸ‘‘
                        </h2>
                        <div class="w-10"></div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-6 bg-white p-4 rounded-2xl shadow-sm border-2 border-amber-100">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-sm font-bold text-amber-800">ã‚ã¤ã‚ãŸæ•°</span>
                            <span class="text-2xl font-black text-amber-600">${collectedStamps} <span class="text-sm text-amber-400 font-bold">/ ${totalStamps}</span></span>
                        </div>
                        <div class="h-4 bg-amber-100 rounded-full overflow-hidden">
                            <div class="h-full bg-amber-400 rounded-full transition-all duration-1000 ease-out" style="width: ${percentage}%"></div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl p-4 shadow-xl border-4 border-amber-200 min-h-[500px] relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-6 bg-gradient-to-b from-amber-50 to-transparent opacity-50 pointer-events-none"></div>
                        
                        <div class="grid grid-cols-4 sm:grid-cols-5 gap-2 relative z-10 pb-4">`;

            Object.values(DATA).forEach(cat => {
                const p = progress[cat.id] || { perfectCount: 0, stamp: null };
                const hasStamp = !!p.stamp;
                const remaining = Math.max(0, 3 - p.perfectCount);

                html += `
                <div class="flex flex-col items-center group">
                    <div class="aspect-square w-full rounded-lg border-2 flex items-center justify-center relative bg-slate-50 transition-all
                        ${hasStamp ? 'border-amber-300 bg-amber-50 shadow-sm scale-100' : 'border-dashed border-slate-200 opacity-70'}
                    ">
                        ${hasStamp 
                            ? `<div class="text-3xl animate-shine drop-shadow-sm filter">${p.stamp}</div>`
                            : `<div class="text-center w-full">
                                ${p.perfectCount > 0 
                                    ? `<div class="text-[10px] font-bold text-amber-500 bg-amber-100 rounded-full px-1 mx-1">ã‚ã¨${remaining}</div>`
                                    : ``
                                }
                                <div class="opacity-20 text-xl grayscale mt-0.5">${cat.words[0].emoji}</div>
                               </div>`
                        }
                    </div>
                    <div class="text-[9px] font-bold text-slate-400 mt-1 w-full text-center truncate leading-tight tracking-tighter">
                        ${cat.label.split('(')[0].replace(/[0-9â‘ â‘¡]/g, '')}
                    </div>
                </div>`;
            });

            html += `</div></div></div></div>`;
            app.innerHTML = html;
        }

        function renderStampSelect() {
            const cat = DATA[state.currentCategory];
            let html = `
            <div class="min-h-screen bg-slate-50 p-4 flex items-center justify-center w-full">
                <div class="max-w-md w-full bg-white rounded-3xl p-6 shadow-xl border-4 border-yellow-200">
                    <div class="text-center mb-6">
                        <div class="inline-block p-3 rounded-full bg-yellow-100 text-yellow-500 mb-4 animate-bounce">
                            <i data-lucide="crown" class="w-10 h-10"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-slate-800">ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆï¼</h2>
                        <p class="text-slate-500 font-bold mt-2 text-sm">ã€Œ${cat.label.split('(')[0]}ã€ã®<br/>ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ ãˆã‚‰ã‚“ã§ã­ï¼</p>
                    </div>
                    <div class="grid grid-cols-5 gap-3 max-h-80 overflow-y-auto p-2">
                        ${STAMP_OPTIONS.map(s => `
                            <button onclick="getStamp('${s}')" class="aspect-square text-3xl flex items-center justify-center rounded-xl hover:bg-yellow-50 hover:scale-110 transition-all cursor-pointer border-2 border-transparent hover:border-yellow-300">
                                ${s}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>`;
            app.innerHTML = html;
        }

        function renderGame(currentUser) {
            const cat = DATA[state.currentCategory];
            const currentWordData = cat.words[state.questionIndex];
            const sizeClass = getSlotSizeClass(currentWordData.en.length);
            const progressPercent = ((state.questionIndex) / cat.words.length) * 100;

            let html = `
            <div class="min-h-screen bg-slate-100 flex flex-col items-center p-4 transition-all w-full">
                <div class="w-full md:max-w-4xl max-w-md flex justify-between items-center mb-6 pt-2">
                    <button onclick="updateScreen('home'); playTone('tap')" class="p-2 bg-white rounded-full shadow-sm text-slate-400 hover:text-slate-600">
                        <i data-lucide="home" class="w-6 h-6"></i>
                    </button>
                    <div class="flex-1 mx-4">
                        <div class="h-3 w-full bg-slate-200 rounded-full overflow-hidden relative">
                            <div class="h-full bg-gradient-to-r ${cat.color} transition-all duration-500" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="text-center text-xs font-bold text-slate-400 mt-1">${state.questionIndex + 1} / ${cat.words.length}</div>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="toggleHint()" class="flex items-center gap-1 px-3 py-2 rounded-full transition-all shadow-sm ${state.showHint ? 'bg-yellow-100 text-yellow-600 border-2 border-yellow-200' : 'bg-white text-slate-400 border-2 border-slate-200'}">
                            <i data-lucide="lightbulb" class="w-5 h-5 ${state.showHint ? 'fill-yellow-400 text-yellow-400' : ''}"></i>
                            <span class="text-xs font-bold">ãƒ’ãƒ³ãƒˆ</span>
                        </button>
                        <button onclick="toggleSound()" class="p-2 rounded-full transition-colors ${state.isSoundOn ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-200 text-slate-400'}">
                            <i data-lucide="${state.isSoundOn ? 'volume-2' : 'volume-x'}" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div class="w-full md:max-w-4xl max-w-md flex-1 flex flex-col items-center">
                    <div class="w-full bg-white rounded-3xl shadow-lg p-6 mb-6 text-center relative overflow-hidden min-h-[300px] flex flex-col justify-center items-center transition-all duration-500">
                        ${state.isCorrect ? `<div class="absolute inset-0 bg-white z-0 flex items-center justify-center overflow-hidden"><div class="absolute inset-0 bg-gradient-to-b from-white via-white to-green-50 opacity-50"></div></div>` : ''}
                        
                        <div class="z-10 relative w-full flex flex-col items-center">
                            <div class="text-7xl sm:text-8xl mb-2 animate-in zoom-in fade-in duration-500 hover:scale-110 transition-transform cursor-default select-none no-select">${currentWordData.emoji}</div>
                            <p class="text-sm text-slate-400 font-bold tracking-widest uppercase mb-1">Meaning</p>
                            <h2 class="text-4xl font-bold text-slate-800 mb-6 transition-all duration-500">${currentWordData.jp}</h2>

                            <div class="flex gap-4 mb-8">
                                <button onclick="handleSpeak()" class="flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-full font-bold text-sm hover:bg-indigo-100 transition-colors">
                                    <i data-lucide="ear" class="w-5 h-5"></i> ãã
                                </button>
                            </div>

                            <div class="flex flex-wrap justify-center gap-2 min-h-[100px] items-end pb-2 px-2">`;

            state.answerSlots.forEach((letter, i) => {
                const targetChar = currentWordData.en[i];
                const isWrong = letter && letter.char !== targetChar;
                const isSpace = letter && letter.char === ' '; // åˆæœŸé…ç½®ã•ã‚ŒãŸã‚¹ãƒšãƒ¼ã‚¹

                if (state.isCorrect) {
                    html += `<div class="font-black text-transparent bg-clip-text bg-gradient-to-br from-indigo-500 to-purple-600 animate-in zoom-in duration-500 px-0.5 ${sizeClass.text}" style="text-shadow: 0 4px 12px rgba(99, 102, 241, 0.2)">${isSpace ? '&nbsp;' : letter.char}</div>`;
                } else if (isSpace) {
                    html += `<div class="${sizeClass.box} flex items-end justify-center"></div>`;
                } else {
                    html += `
                    <button onclick="handleAnswerClick(${i})" ${!letter ? 'disabled' : ''} class="${sizeClass.box} ${sizeClass.text} rounded-lg flex items-end justify-center font-bold transition-all border-b-4 relative overflow-visible ${letter ? (isWrong ? 'text-red-500 border-red-300 hover:text-red-600' : 'text-indigo-600 border-indigo-400 hover:text-indigo-700 active:translate-y-1 active:border-b-0') : 'border-slate-200 border-dashed border-2'}">
                        ${!letter && state.showHint ? `<span class="text-slate-200 pointer-events-none">${targetChar}</span>` : ''}
                        ${letter ? letter.char : ''}
                        ${isWrong ? `<span class="absolute -top-3 -right-3 bg-white rounded-full shadow-sm z-20"><i data-lucide="alert-circle" class="w-5 h-5 text-red-500 fill-red-50"></i></span>` : ''}
                    </button>`;
                }
            });

            html += `</div></div></div>
            
            <div class="w-full p-4">
                <p class="text-center text-slate-400 text-sm mb-4 font-bold tracking-widest">TAP LETTERS</p>
                <div class="flex flex-wrap justify-center gap-3">`;
            
            state.poolLetters.forEach((letter) => {
                const isUsed = state.answerSlots.some(l => l?.id === letter.id);
                html += `
                <div class="relative ${sizeClass.box}">
                    <button onclick="handlePoolClick('${letter.id}')" ${isUsed || state.isCorrect ? 'disabled' : ''} class="absolute inset-0 w-full h-full bg-white rounded-xl flex items-end justify-center ${sizeClass.text} font-bold text-slate-700 shadow-md border-b-[6px] border-slate-200 active:border-b-0 active:translate-y-1 active:bg-slate-50 transition-all ${isUsed ? 'opacity-0 pointer-events-none' : 'opacity-100'}">
                        ${letter.char}
                    </button>
                    ${isUsed ? `<div class="absolute inset-0 w-full h-full rounded-xl border-2 border-slate-100 bg-slate-50/50"></div>` : ''}
                </div>`;
            });

            html += `</div></div></div>`;

            if (state.isCorrect) {
                html += `
                <div class="fixed bottom-8 w-full max-w-md px-4 animate-in slide-in-from-bottom-4 fade-in duration-300 z-50">
                    <button onclick="nextQuestion()" class="w-full py-5 bg-green-500 text-white rounded-2xl font-bold text-2xl shadow-xl border-b-8 border-green-600 active:border-b-0 active:translate-y-2 flex items-center justify-center gap-3 transition-all hover:bg-green-400">
                        <span>NEXT</span> <i data-lucide="arrow-right" class="w-8 h-8"></i>
                    </button>
                </div>`;
            }

            html += `</div>`;
            app.innerHTML = html;
        }

        function renderResult(user, progress) {
            const cat = DATA[state.currentCategory];
            const remaining = Math.max(0, 3 - (progress[cat.id]?.perfectCount || 0));
            const { isPerfect, canGetStamp } = state.resultInfo;

            let html = `
            <div class="min-h-screen bg-slate-50 flex items-center justify-center p-4 w-full">
                <div class="max-w-md w-full bg-white rounded-3xl p-8 text-center shadow-xl border-4 border-yellow-200 relative overflow-hidden">
                    <div class="mb-6 flex justify-center relative z-10">
                        ${canGetStamp 
                            ? `<div class="relative"><span class="text-8xl animate-bounce inline-block">ğŸ</span><i data-lucide="sparkles" class="absolute -top-4 -right-4 w-12 h-12 text-yellow-300 animate-ping"></i></div>` 
                            : (isPerfect 
                                ? `<i data-lucide="trophy" class="w-24 h-24 text-yellow-400 fill-yellow-100 animate-bounce"></i>` // Perfectã®å ´åˆ
                                : `<i data-lucide="thumbs-up" class="w-24 h-24 text-orange-500 fill-orange-100 animate-bounce"></i>` // é€šå¸¸ã‚¯ãƒªã‚¢ã®å ´åˆï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ã«å¤‰æ›´ï¼‰
                              )
                        }
                    </div>
                    
                    ${isPerfect 
                        ? `<h2 class="text-4xl font-black text-yellow-500 mb-2 drop-shadow-sm">Perfect!!</h2>` 
                        : `<h2 class="text-3xl font-bold text-slate-800 mb-2">Good Job!</h2>`
                    }
                    
                    <p class="text-lg text-slate-600 font-bold mb-6">
                        ã€Œ${cat.label.split('(')[0]}ã€<br/>
                        ${isPerfect ? `ã‹ã‚“ãºãï¼ã™ã”ã„ï¼` : `ã‚¯ãƒªã‚¢ï¼`}
                    </p>

                    ${isPerfect && !canGetStamp ? `
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-6 animate-in zoom-in">
                        <div class="flex items-center justify-center gap-2 text-yellow-600 font-bold mb-1">
                            <i data-lucide="sparkles" class="w-5 h-5"></i><span>ãŠã‚ã§ã¨ã†ï¼</span><i data-lucide="sparkles" class="w-5 h-5"></i>
                        </div>
                        <p class="text-slate-700 font-bold">ãƒ’ãƒ³ãƒˆãªã—ã§ å…¨å•ã‚¯ãƒªã‚¢ã ã‚ˆğŸ…</p>
                        <p class="text-sm text-slate-500 font-bold mt-2">ã‚ã¨ ${remaining}ã‹ã„ã§<br/>ã‚¹ã‚¿ãƒ³ãƒ— ã‚²ãƒƒãƒˆï¼</p>
                    </div>` : ''}

                    ${canGetStamp ? `
                    <div class="mb-6 animate-in zoom-in duration-500">
                        <button onclick="updateScreen('stampSelect'); playTone('tap')" class="w-full py-4 bg-yellow-400 text-white rounded-2xl font-black text-xl shadow-lg border-b-4 border-yellow-600 active:border-b-0 active:translate-y-1 animate-pulse">
                            ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ ãˆã‚‰ã¶ï¼
                        </button>
                    </div>` : `
                    <div class="flex flex-col gap-3 relative z-10">
                        <button onclick="startCategory('${cat.id}')" class="w-full py-4 rounded-xl bg-indigo-600 text-white font-bold text-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="refresh-ccw" class="w-5 h-5"></i> ã‚‚ã†ã„ã¡ã© ã‚„ã‚‹
                        </button>
                        <button onclick="updateScreen('home'); playTone('tap')" class="w-full py-4 rounded-xl bg-slate-200 text-slate-700 font-bold text-lg hover:bg-slate-300 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="home" class="w-5 h-5"></i> ã»ã‹ã® ã‚«ãƒ†ã‚´ãƒª
                        </button>
                    </div>`}
                </div>
            </div>`;
            app.innerHTML = html;
        }

        function renderHistory() {
            const history = (state.currentUserId && state.allUsersData[state.currentUserId]) ? state.allUsersData[state.currentUserId].history : [];
            let html = `
            <div class="min-h-screen bg-slate-50 p-4 w-full">
                <div class="max-w-md mx-auto pt-2 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <button onclick="updateScreen('home'); playTone('tap')" class="p-2 bg-white rounded-full shadow-sm text-slate-400 hover:text-slate-600">
                            <i data-lucide="arrow-left" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                            <i data-lucide="history" class="w-6 h-6 text-indigo-500"></i> ã‚ãã‚“ã  ãã‚ã
                        </h2>
                        <div class="w-10"></div>
                    </div>
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 flex-1 overflow-hidden flex flex-col min-h-[400px]">
                        <div class="p-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-500">${history.length} ã‹ã„</span>
                                <span class="text-[10px] text-slate-400 font-bold">â€»ã•ã„ã—ã‚“ ${HISTORY_LIMIT}ã‘ã‚“ ã¾ã§</span>
                            </div>
                            ${history.length > 0 ? `<button onclick="clearHistory()" class="text-xs flex items-center gap-1 text-red-400 hover:text-red-600 font-bold bg-white px-3 py-1.5 rounded-full border border-red-100"><i data-lucide="trash-2" class="w-3 h-3"></i> ãœã‚“ã¶ã‘ã™</button>` : ''}
                        </div>
                        <div class="overflow-y-auto flex-1 p-2 space-y-2">`;

            if (history.length === 0) {
                html += `<div class="h-40 flex items-center justify-center text-slate-400 font-bold">ã¾ã  ãã‚ããŒ ãªã„ã‚ˆ</div>`;
            } else {
                history.forEach(record => {
                    const cat = DATA[record.categoryId];
                    html += `
                    <div class="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br ${cat?.color || 'from-slate-300 to-slate-400'} flex items-center justify-center text-2xl text-white">
                            ${cat?.words[0].emoji || '?'}
                        </div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-700">${cat?.label.split('(')[0] || 'Unknown'}</div>
                            <div class="text-xs text-slate-400 font-bold">${record.date}</div>
                        </div>
                        ${record.isPerfect ? `<div class="bg-yellow-100 text-yellow-600 px-2 py-1 rounded-md text-xs font-bold border border-yellow-200">ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ</div>` : ''}
                    </div>`;
                });
            }

            html += `</div></div></div></div>`;
            app.innerHTML = html;
        }

        // --- 6. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ & ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ© ---

        function toggleSound() {
            state.isSoundOn = !state.isSoundOn;
            initAudio(); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§AudioContextå†é–‹
            render();
        }

        function selectUser(userId) {
            playTone('tap');
            initAudio();
            state.currentUserId = userId;
            updateScreen('home');
        }

        function startEditUser() {
            playTone('tap');
            state.editingUser = { name: '', icon: ICON_OPTIONS[0], color: COLOR_OPTIONS[0].class };
            updateScreen('userEdit');
        }

        // ä¿®æ­£: render()ã‚’å‘¼ã°ãšã€DOMã‚’ç›´æ¥æ“ä½œã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚Œã‚’é˜²ã
        function updateEditingName(val) { 
            state.editingUser.name = val; 
            
            // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã ã‘æ›´æ–°
            const btn = document.getElementById('saveUserBtn');
            if (btn) {
                if (val) {
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-300');
                    btn.classList.add('bg-indigo-500', 'hover:bg-indigo-600', 'shadow-md', 'transform', 'hover:-translate-y-1');
                } else {
                    btn.disabled = true;
                    btn.classList.add('bg-slate-300');
                    btn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600', 'shadow-md', 'transform', 'hover:-translate-y-1');
                }
            }
        }
        function updateEditingIcon(icon) { state.editingUser.icon = icon; render(); }
        function updateEditingColor(color) { state.editingUser.color = color; render(); }

        function saveUserEdit() {
            if (!state.editingUser.name) return;
            playTone('correct');
            
            if (state.editingUser.id) {
                state.users = state.users.map(u => u.id === state.editingUser.id ? state.editingUser : u);
            } else {
                const newUser = { ...state.editingUser, id: Date.now().toString() };
                state.users.push(newUser);
                state.allUsersData[newUser.id] = { history: [], progress: {} };
                saveData();
            }
            saveUsers();
            updateScreen('userSelect');
        }

        function deleteUser(userId) {
            if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã€ãã‚ãã‚’ ã•ãã˜ã‚‡ã—ã¾ã™ã‹ï¼Ÿ')) return;
            playTone('remove');
            state.users = state.users.filter(u => u.id !== userId);
            delete state.allUsersData[userId];
            saveUsers();
            saveData();
            render();
        }

        function startCategory(catId) {
            playTone('tap');
            state.currentCategory = catId;
            state.questionIndex = 0;
            state.usedHintInSession = false;
            state.hasErrorInSession = false;
            // state.showHint = false; // ãƒ’ãƒ³ãƒˆçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ãƒªã‚»ãƒƒãƒˆã—ãªã„
            loadQuestion(catId, 0);
            updateScreen('game');
        }

        function loadQuestion(catId, index) {
            const cat = DATA[catId];
            const targetWord = cat.words[index].en;
            
            const letters = targetWord.split('').map((char, i) => ({ char, id: `${char}-${i}-${Math.random()}` }));
            // ã‚¹ãƒšãƒ¼ã‚¹ä»¥å¤–ã‚’ãƒ—ãƒ¼ãƒ«ã¸
            state.poolLetters = letters.filter(l => l.char !== ' ').sort(() => Math.random() - 0.5);
            // ã‚¹ãƒšãƒ¼ã‚¹ã¯åˆæœŸé…ç½®
            state.answerSlots = letters.map(l => l.char === ' ' ? l : null);
            
            state.isCorrect = false;
            // state.showHint = false; // ãƒ’ãƒ³ãƒˆçŠ¶æ…‹ã‚’ç¶­æŒã™ã‚‹ãŸã‚ãƒªã‚»ãƒƒãƒˆã—ãªã„
            
            setTimeout(() => speak(targetWord), 500);
        }

        function handlePoolClick(letterId) {
            if (state.isCorrect) return;
            const letter = state.poolLetters.find(l => l.id === letterId);
            if (!letter) return;
            
            // æ—¢ã«é…ç½®æ¸ˆã¿ãªã‚‰ç„¡è¦–ï¼ˆå¿µã®ãŸã‚ï¼‰
            if (state.answerSlots.some(l => l?.id === letter.id)) return;

            const firstEmptyIndex = state.answerSlots.findIndex(slot => slot === null);
            if (firstEmptyIndex !== -1) {
                // ãƒŸã‚¹åˆ¤å®š
                const cat = DATA[state.currentCategory];
                const targetChar = cat.words[state.questionIndex].en[firstEmptyIndex];
                if (letter.char !== targetChar) {
                    state.hasErrorInSession = true;
                }

                playTone('tap');
                state.answerSlots[firstEmptyIndex] = letter;
                render(); // å†æç”»
                checkAnswer();
            }
        }

        function handleAnswerClick(index) {
            if (state.isCorrect) return;
            const slot = state.answerSlots[index];
            if (slot && slot.char === ' ') return; // ã‚¹ãƒšãƒ¼ã‚¹ã¯æ¶ˆã›ãªã„
            
            playTone('remove');
            state.answerSlots[index] = null;
            render();
        }

        function toggleHint() {
            if (!state.showHint) {
                playTone('hint');
                state.showHint = true;
                state.usedHintInSession = true; // ãƒ’ãƒ³ãƒˆã‚’ä½¿ã£ãŸãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆPerfectåˆ¤å®šç”¨ï¼‰
                render();
            } else {
                state.showHint = false;
                render();
            }
        }

        function handleSpeak() {
            const word = DATA[state.currentCategory].words[state.questionIndex].en;
            speak(word);
        }

        function checkAnswer() {
            const cat = DATA[state.currentCategory];
            const targetWord = cat.words[state.questionIndex].en;
            const currentAnswer = state.answerSlots.map(l => l ? l.char : '').join('');

            if (state.answerSlots.every(s => s !== null) && currentAnswer === targetWord) {
                playTone('correct');
                state.isCorrect = true;
                render();
                setTimeout(() => speak("Great! " + targetWord), 300);
            }
        }

        function nextQuestion() {
            playTone('tap');
            const cat = DATA[state.currentCategory];
            if (state.questionIndex + 1 < cat.words.length) {
                state.questionIndex++;
                loadQuestion(state.currentCategory, state.questionIndex);
                render();
            } else {
                // Complete
                // playTone()ã¯renderResultå¾Œã€æ¡ä»¶ã«å¿œã˜ã¦å‘¼ã¶ã‹ã€ã“ã“ã§å‘¼ã¶ã‹
                // ã“ã“ã§isPerfectåˆ¤å®šã‚’è¡Œã†
                const isPerfect = !state.usedHintInSession && !state.hasErrorInSession;
                
                // éŸ³å£°åˆ†å²
                if (isPerfect) {
                    // ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆã®å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŒã€ä¸€æ—¦PerfectéŸ³ã§ç¥ç¦ï¼ˆã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆæ™‚ã¯å¾Œã§CrownéŸ³ãŒãªã‚‹ï¼‰
                    playTone('perfect');
                } else {
                    playTone('complete');
                }

                const now = new Date();
                const today = now.toLocaleDateString('ja-JP') + ' ' + now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
                
                const user = state.allUsersData[state.currentUserId];
                user.history.unshift({ date: today, categoryId: state.currentCategory, isPerfect });
                
                // å±¥æ­´ä¸Šé™ãƒã‚§ãƒƒã‚¯
                if (user.history.length > HISTORY_LIMIT) {
                    user.history = user.history.slice(0, HISTORY_LIMIT);
                }
                
                let canGetStamp = false;
                if (isPerfect) {
                    if (!user.progress[state.currentCategory]) {
                        user.progress[state.currentCategory] = { perfectCount: 0, stamp: null };
                    }
                    if (!user.progress[state.currentCategory].stamp) {
                        user.progress[state.currentCategory].perfectCount += 1;
                        if (user.progress[state.currentCategory].perfectCount >= 3) {
                            canGetStamp = true;
                            // ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆã®éŸ³ã¯å°‘ã—é…ã‚‰ã›ã¦ç‰¹åˆ¥æ„Ÿã‚’å‡ºã™
                            setTimeout(() => playTone('crown'), 1500); 
                        }
                    }
                }
                saveData();
                state.resultInfo = { isPerfect, canGetStamp };
                updateScreen('result');
            }
        }

        function getStamp(stamp) {
            const user = state.allUsersData[state.currentUserId];
            if (user.progress[state.currentCategory]) {
                user.progress[state.currentCategory].stamp = stamp;
            }
            saveData();
            playTone('stamp');
            updateScreen('stampBook');
        }

        function clearHistory() {
            if (!confirm('ã»ã‚“ã¨ã†ã« ãã‚ãã‚’ ãœã‚“ã¶ ã‘ã—ã¾ã™ã‹ï¼Ÿ')) return;
            state.allUsersData[state.currentUserId].history = [];
            saveData();
            playTone('remove');
            render();
        }

        // åˆæœŸåŒ–
        initData();
        render();

    </script>
</body>
</html>